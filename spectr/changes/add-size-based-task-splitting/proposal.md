# Change: Add Size-Based Task Splitting for Large tasks.jsonc Files

## Why

Large change proposals with 50+ tasks produce `tasks.jsonc` files that exceed typical AI agent Read operation limits (~100-150 lines). This forces agents to either:
1. Request partial reads with offset/limit (losing context)
2. Hit token/line truncation limits (missing tasks)
3. Fail to understand the full scope of work

Claude Code and other AI agents work best when they can read entire task files in one operation. By automatically splitting large `tasks.md` files into multiple smaller `tasks.jsonc` files at accept time, we ensure optimal agent readability while maintaining human-friendly single-file authoring.

This replaces the previous `add-hierarchical-tasks` proposal, which tied splitting to delta spec directories. The new approach is simpler: split based purely on file size, using section boundaries for clean breaks.

## What Changes

- **ADDED**: Automatic detection of large tasks.md files (>100 lines) during `spectr accept`
- **ADDED**: Smart splitting logic that preserves section boundaries and subsection groupings
- **ADDED**: Root `tasks.jsonc` with references to split files (`tasks-1.jsonc`, `tasks-2.jsonc`, etc.)
- **ADDED**: Child task file format with full headers documenting origin (parent change ID, parent task ID)
- **ADDED**: Task reference syntax using `"children": "$ref:tasks-N.jsonc"` for hierarchical navigation
- **ADDED**: Version 2 schema for tasks.jsonc with `children`, `parent`, and `includes` fields
- **MODIFIED**: `spectr accept` command to implement splitting logic with 100-line threshold
- **MODIFIED**: Task ID schema to support hierarchical IDs (e.g., `5.1`, `5.1.1`)

## Impact

- **Affected specs**: `cli-interface`
- **Affected code**:
  - `cmd/accept.go` - add splitting detection and orchestration
  - `cmd/accept_writer.go` - new functions for writing split files
  - `internal/parsers/types.go` - add Children, Parent, Includes fields
  - `internal/parsers/parsers.go` - add ReadTasksFile function for hierarchical reading
- **Breaking changes**: None - Version 1 flat files remain fully supported
- **Replaces**: The `add-hierarchical-tasks` change proposal (will be archived without implementation)

## Examples

### Before (flat, 150-line tasks.md)

```
spectr/changes/my-big-change/
├── proposal.md
├── tasks.md          (150 lines, 45 tasks)
└── tasks.jsonc       (generated: 150 lines, hard to read)
```

### After (split across 2 files)

```
spectr/changes/my-big-change/
├── proposal.md
├── tasks.md          (150 lines, source of truth)
├── tasks.jsonc       (root: 40 lines with refs)
├── tasks-1.jsonc     (section 1: 60 lines)
└── tasks-2.jsonc     (section 2: 50 lines)
```

Root `tasks.jsonc`:
```jsonc
{
  "version": 2,
  "tasks": [
    {
      "id": "1",
      "section": "Implementation",
      "description": "Implement core features",
      "status": "pending",
      "children": "$ref:tasks-1.jsonc"
    },
    {
      "id": "2",
      "section": "Testing",
      "description": "Add test coverage",
      "status": "pending",
      "children": "$ref:tasks-2.jsonc"
    }
  ],
  "includes": ["tasks-*.jsonc"]
}
```

Child `tasks-1.jsonc`:
```jsonc
// Generated by: spectr accept add-size-based-task-splitting
// Parent change: add-size-based-task-splitting
// Parent task: 1
// Status values: "pending" | "in_progress" | "completed"
{
  "version": 2,
  "parent": "1",
  "tasks": [
    {
      "id": "1.1",
      "section": "Implementation",
      "description": "Create database schema",
      "status": "pending"
    },
    {
      "id": "1.2",
      "section": "Implementation",
      "description": "Implement API handlers",
      "status": "pending"
    }
  ]
}
```
