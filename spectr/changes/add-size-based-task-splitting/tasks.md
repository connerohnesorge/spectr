# Implementation Tasks

## 0. JSONC Marshalling Fix (CRITICAL - Do First)

**Issue**: `json.MarshalIndent()` double-escapes quotes in task descriptions,
producing invalid JSONC. This breaks file generation and agent readability.

- [ ] 0.1 Create new file `cmd/jsonc.go` for custom JSONC marshalling
- [ ] 0.2 Implement `escapeJSONString()` function to properly escape quotes
  without double-escaping
- [ ] 0.3 Implement `MarshalTaskToJSONLines()` to convert single Task to JSONC
  format
- [ ] 0.4 Implement `MarshalTasksToJSONLines()` to convert task array with proper
  indentation
- [ ] 0.5 Implement `ValidateJSONCSyntax()` to validate output is valid JSONC before
  writing
- [ ] 0.6 Add unit tests for quote escaping (simple, escaped, special chars, newlines)
- [ ] 0.7 Add unit tests for JSONC validation with trailing commas
- [ ] 0.8 Add unit tests for proper task serialization round-trip
- [ ] 0.9 Update `cmd/accept_writer.go` line 77-81 to use custom marshaller instead
  of `json.MarshalIndent()`
- [ ] 0.10 Update `writeTasksJSONC()` to validate JSONC output before writing
- [ ] 0.11 Run existing tests to verify no regressions

## 1. Schema Updates

- [x] 1.1 Update `internal/parsers/types.go` to add `Children` field to Task
  struct with JSON tag `children,omitempty`
- [x] 1.2 Add `Parent` field to TasksFile struct with JSON tag `parent,omitempty`
- [x] 1.3 Add `Includes` field to TasksFile struct with JSON tag `includes,omitempty`
- [x] 1.4 Update TasksFile Version constant to support version 2 detection
- [x] 1.5 Add unit tests for new struct fields serialization/deserialization

## 2. Line Counting and Split Detection

- [x] 2.1 Add `countLines()` function in `cmd/accept.go` to count lines in
  tasks.md file
- [x] 2.2 Add `shouldSplit()` function that returns true if line count exceeds 100
- [x] 2.3 Add unit tests for line counting with various file sizes
- [x] 2.4 Add unit tests for split detection threshold

## 3. Section Parsing

- [x] 3.1 Add `Section` struct to represent a section with name, tasks, and
  line range
- [x] 3.2 Add `parseSections()` function to extract sections from tasks.md by
  `## N.` headers
- [x] 3.3 Add `extractTasksForSection()` function to get tasks belonging to a section
- [x] 3.4 Add unit tests for section parsing with multiple sections
- [x] 3.5 Add unit tests for malformed section headers
- [x] 3.6 Add unit tests for tasks without sections

## 4. Subsection Splitting Logic

- [x] 4.1 Add `shouldSplitSection()` function to check if a section exceeds 100
  lines
- [x] 4.2 Add `parseSubsections()` function to group tasks by ID prefix
  (e.g., "1.1", "1.2")
- [x] 4.3 Add `SubsectionGroup` struct to hold tasks with common ID prefix
- [x] 4.4 Add unit tests for subsection grouping by ID prefix
- [x] 4.5 Add unit tests for large section splitting into multiple files

## 5. Hierarchical ID Assignment

- [x] 5.1 Add `assignHierarchicalID()` function to generate dot-notation IDs
- [x] 5.2 Add logic to preserve existing IDs from tasks.md and add parent prefix
  for children
- [x] 5.3 Add `validateIDUniqueness()` function to ensure no duplicate IDs
- [x] 5.4 Add unit tests for hierarchical ID generation
- [x] 5.5 Add unit tests for ID uniqueness validation

## 6. Status Aggregation

- [x] 6.1 Add `computeAggregateStatus()` function implementing aggregation rules
- [x] 6.2 Implement "all pending → pending" rule
- [x] 6.3 Implement "any in_progress → in_progress" rule
- [x] 6.4 Implement "all completed → completed" rule
- [x] 6.5 Implement "mixed pending+completed → in_progress" rule
- [x] 6.6 Add unit tests for all status aggregation scenarios

## 7. Status Preservation Across Regeneration

- [x] 7.1 Add `loadExistingStatuses()` function to read old tasks.jsonc files
- [x] 7.2 Build map of task ID → status from existing files
- [x] 7.3 Add logic to merge old statuses with new task structure during write
- [x] 7.4 Add unit tests for status preservation when IDs match
- [x] 7.5 Add unit tests for new tasks getting "pending" status

## 8. Child File Header Generation

- [x] 8.1 Add `childFileHeader()` function to generate header with origin info
- [x] 8.2 Include "Generated by: spectr accept `<change-id>`" line
- [x] 8.3 Include "Parent change: `<change-id>`" line
- [x] 8.4 Include "Parent task: `<task-id>`" line
- [x] 8.5 Include full standard header (status values, transitions)
- [x] 8.6 Add unit tests for header generation with all fields

## 9. File Writing Functions

- [x] 9.1 Add `writeHierarchicalTasks()` orchestration function in
  `cmd/accept_writer.go`
- [x] 9.2 Add `writeRootTasksJSONC()` to write root file with reference tasks
- [x] 9.3 Add `writeChildTasksJSONC()` to write tasks-N.jsonc files
- [x] 9.4 Add `deleteOldChildFiles()` function to clean up tasks-*.jsonc before
  regeneration
- [x] 9.5 Update existing `writeTasksJSONC()` to route to hierarchical path when
  needed
- [x] 9.6 Add includes field `["tasks-*.jsonc"]` to root file
- [x] 9.7 Add unit tests for root file generation with references
- [x] 9.8 Add unit tests for child file generation
- [x] 9.9 Add unit tests for old file cleanup

## 10. Accept Command Integration

- [x] 10.1 Update `processChange()` in `cmd/accept.go` to call `shouldSplit()`
- [x] 10.2 Route to `writeHierarchicalTasks()` when splitting is needed
- [x] 10.3 Route to existing `writeTasksJSONC()` for flat files (version 1)
- [x] 10.4 Add integration test with 150-line tasks.md generating split files
- [x] 10.5 Add integration test with 80-line tasks.md generating flat file
- [x] 10.6 Add integration test for regeneration preserving statuses

## 11. Backwards Compatibility

- [x] 11.1 Ensure version 1 files are parsed correctly (no split lookup)
- [x] 11.2 Add `isVersionTwo()` function to detect hierarchical format
- [x] 11.3 Add unit tests for reading version 1 flat files
- [x] 11.4 Add unit tests for version 1 → version 2 upgrade path
- [x] 11.5 Add integration test with mixed version 1 and version 2 changes

## 12. Edge Cases and Error Handling

- [x] 12.1 Handle tasks.md with no sections (generate flat file)
- [x] 12.2 Handle tasks.md with only one section (no splitting needed)
- [x] 12.3 Handle tasks.md exactly 100 lines (use flat format)
- [x] 12.4 Handle tasks.md with 101 lines (trigger splitting)
- [x] 12.5 Handle malformed task IDs gracefully
- [x] 12.6 Handle missing parent tasks in child files (validation error)
- [x] 12.7 Add unit tests for all edge cases

## 13. Documentation

- [x] 13.1 Update AGENTS.md with version 2 format documentation
- [x] 13.2 Add example hierarchical tasks.jsonc structure to AGENTS.md
- [x] 13.3 Document 100-line threshold and splitting behavior
- [x] 13.4 Document child file naming convention (tasks-N.jsonc)
- [x] 13.5 Document status aggregation rules
- [x] 13.6 Update internal code comments for new functions

## 14. Testing and Validation

- [x] 14.1 Run `nix develop -c tests` to ensure all unit tests pass
- [x] 14.2 Run `nix develop -c lint` to ensure code quality
- [x] 14.3 Create manual test change with 150+ line tasks.md
- [x] 14.4 Run `spectr accept` on manual test change and verify split files
- [x] 14.5 Verify agent can read root file in single Read operation
- [x] 14.6 Verify agent can read child files in single Read operation
- [x] 14.7 Update task status in child file and verify regeneration preserves it
- [x] 14.8 Run `spectr validate` on test change to ensure specs are valid

## 15. Cleanup and Archive Old Proposal

- [x] 15.1 Archive the `add-hierarchical-tasks` change without implementing
- [x] 15.2 Add note in archive explaining it was superseded by this change
- [x] 15.3 Clean up any stale development artifacts
