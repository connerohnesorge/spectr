# Delta Specification

## MODIFIED Requirements

### Requirement: Task Counting

The system SHALL count tasks from `tasks.jsonc` or `tasks.md` files. Legacy
`tasks.json` files are silently ignored (breaking change).

#### Scenario: Count tasks from JSONC

- WHEN the system counts tasks and `tasks.jsonc` exists
- THEN it reads task status from the JSONC file
- AND strips any comments before parsing
- AND counts tasks by status field values
- AND reports `taskStatus` with total and completed counts

#### Scenario: Count tasks from Markdown

- WHEN the system counts tasks and `tasks.jsonc` does not exist but `tasks.md`
  exists
- THEN it identifies lines matching `- [ ]` or `- [x]` (case-insensitive)
- AND counts completed tasks by `[x]` markers
- AND reports `taskStatus` with total and completed counts

#### Scenario: Ignore legacy tasks.json

- WHEN the system counts tasks and only `tasks.json` exists (no `tasks.jsonc` or
  `tasks.md`)
- THEN it reports `taskStatus` as `{ total: 0, completed: 0 }`
- AND does NOT read the legacy `tasks.json` file

#### Scenario: Handle missing tasks file

- WHEN the system cannot find `tasks.jsonc` or `tasks.md` for a change
- THEN it reports `taskStatus` as `{ total: 0, completed: 0 }`
- AND continues processing without error

#### Scenario: JSONC takes precedence over Markdown

- WHEN both `tasks.jsonc` and `tasks.md` exist
- THEN the system reads from `tasks.jsonc`
- AND ignores `tasks.md`

### Requirement: Accept Command Structure

The CLI SHALL provide an `accept` command that converts `tasks.md` to
`tasks.jsonc` format with header comments for stable agent manipulation during
implementation.

#### Scenario: Accept command registration

- WHEN the CLI is initialized
- THEN it SHALL include an AcceptCmd struct field tagged with `cmd`
- AND the command SHALL be accessible via `spectr accept`
- AND the command help text SHALL reference tasks.jsonc output

#### Scenario: Accept with change ID

- WHEN user runs `spectr accept <change-id>`
- THEN the system validates the change exists in `spectr/changes/<change-id>/`
- AND the system parses `tasks.md` into structured format
- AND the system writes `tasks.jsonc` with proper schema and header comments
- AND the system removes `tasks.md` to prevent drift

#### Scenario: Accept with validation

- WHEN user runs `spectr accept <change-id>`
- THEN the system validates the change before conversion
- AND if validation fails, the system aborts
- AND the system displays validation errors

#### Scenario: Accept dry-run mode

- WHEN user runs `spectr accept <change-id> --dry-run`
- THEN the system displays what would be converted
- AND the system does NOT write tasks.jsonc
- AND the system does NOT remove tasks.md

#### Scenario: Accept already accepted change

- WHEN user runs `spectr accept <change-id>` on a change that already has
  tasks.jsonc
- THEN the system displays a message indicating change is already accepted
- AND the system exits with code 0 (success, idempotent)

#### Scenario: Accept change without tasks.md

- WHEN user runs `spectr accept <change-id>` on a change without tasks.md
- THEN the system displays an error indicating no tasks.md found
- AND the system exits with code 1

### Requirement: Tasks JSON Schema

The accept command SHALL generate `tasks.jsonc` files conforming to a versioned
schema with structured task objects and header comments.

#### Scenario: JSONC file structure

- WHEN the accept command creates tasks.jsonc
- THEN the file SHALL start with header comments documenting task status values
- AND the file SHALL contain a root object with `version` and `tasks` fields
- AND `version` SHALL be integer 1 for this schema version
- AND `tasks` SHALL be an array of task objects

#### Scenario: Header comment content

- WHEN the accept command creates tasks.jsonc
- THEN the header SHALL use `//` line comment syntax
- AND the header SHALL indicate the file is machine-generated by `spectr accept`
- AND the header SHALL document the three valid status values: "pending",
  "in_progress", "completed"
- AND the header SHALL document valid status transitions: pending → in_progress
  → completed
- AND the header SHALL explain that agents should mark a task "in_progress" when
  starting work
- AND the header SHALL explain that agents should mark a task "completed" only
  after verification
- AND the header SHALL note that skipping directly from "pending" to "completed"
  is allowed for trivial tasks

#### Scenario: Task object structure

- WHEN a task is serialized to JSONC
- THEN it SHALL have `id` field containing the task identifier (e.g., "1.1")
- AND it SHALL have `section` field containing the section header (e.g.,
  "Implementation")
- AND it SHALL have `description` field containing the full task text
- AND it SHALL have `status` field with value "pending", "in_progress", or
  "completed"

#### Scenario: Status value mapping from Markdown

- WHEN converting tasks.md to tasks.jsonc
- THEN `- [ ]` SHALL map to status "pending"
- AND `- [x]` (case-insensitive) SHALL map to status "completed"

### Requirement: Accept Command Flags

The accept command SHALL support flags for controlling behavior.

#### Scenario: Dry-run flag

- WHEN user provides the `--dry-run` flag
- THEN the system previews the conversion without writing files
- AND displays the JSON that would be generated

#### Scenario: Interactive change selection

- WHEN user runs `spectr accept` without specifying a change ID
- THEN the system displays a list of active changes with tasks.md files
- AND prompts for selection using existing TUI components

## ADDED Requirements

### Requirement: JSONC Comment Parsing

The system SHALL support reading JSONC files by stripping comments before JSON
parsing.

#### Scenario: Strip line comments

- WHEN reading a JSONC file containing `//` line comments
- THEN the parser SHALL remove all text from `//` to end of line
- AND the resulting JSON SHALL parse correctly

#### Scenario: Strip block comments

- WHEN reading a JSONC file containing `/* */` block comments
- THEN the parser SHALL remove all text between `/*` and `*/`
- AND the resulting JSON SHALL parse correctly

#### Scenario: Preserve comments in strings

- WHEN reading a JSONC file with `//` or `/*` inside a JSON string value
- THEN the parser SHALL NOT treat the text as a comment
- AND the string value SHALL be preserved intact

#### Scenario: Parse plain JSON

- WHEN reading a JSON file without comments
- THEN the parser SHALL parse it successfully
- AND no comment stripping side effects SHALL occur
