# Implementation Tasks

## 1. Schema Updates

- [ ] 1.1 Update `internal/parsers/types.go` to add `Children` field to Task
  struct with JSON tag `children,omitempty`
- [ ] 1.2 Add `Parent` field to TasksFile struct with JSON tag
  `parent,omitempty`
- [ ] 1.3 Add `Includes` field to TasksFile struct with JSON tag
  `includes,omitempty`
- [ ] 1.4 Update TasksFile Version constant to support version 2 detection
- [ ] 1.5 Add unit tests for new struct fields serialization/deserialization

## 2. Line Counting and Split Detection

- [ ] 2.1 Add `countLines()` function in `cmd/accept.go` to count lines in
  tasks.md file
- [ ] 2.2 Add `shouldSplit()` function that returns true if line count exceeds
  100
- [ ] 2.3 Add unit tests for line counting with various file sizes
- [ ] 2.4 Add unit tests for split detection threshold

## 3. Section Parsing

- [ ] 3.1 Add `Section` struct to represent a section with name, tasks, and line
  range
- [ ] 3.2 Add `parseSections()` function to extract sections from tasks.md by
  `## N.` headers
- [ ] 3.3 Add `extractTasksForSection()` function to get tasks belonging to a
  section
- [ ] 3.4 Add unit tests for section parsing with multiple sections
- [ ] 3.5 Add unit tests for malformed section headers
- [ ] 3.6 Add unit tests for tasks without sections

## 4. Subsection Splitting Logic

- [ ] 4.1 Add `shouldSplitSection()` function to check if a section exceeds 100
  lines
- [ ] 4.2 Add `parseSubsections()` function to group tasks by ID prefix (e.g.,
  "1.1", "1.2")
- [ ] 4.3 Add `SubsectionGroup` struct to hold tasks with common ID prefix
- [ ] 4.4 Add unit tests for subsection grouping by ID prefix
- [ ] 4.5 Add unit tests for large section splitting into multiple files

## 5. Hierarchical ID Assignment

- [ ] 5.1 Add `assignHierarchicalID()` function to generate dot-notation IDs
- [ ] 5.2 Add logic to preserve existing IDs from tasks.md and add parent prefix
  for children
- [ ] 5.3 Add `validateIDUniqueness()` function to ensure no duplicate IDs
- [ ] 5.4 Add unit tests for hierarchical ID generation
- [ ] 5.5 Add unit tests for ID uniqueness validation

## 6. Status Aggregation

- [ ] 6.1 Add `computeAggregateStatus()` function implementing aggregation rules
- [ ] 6.2 Implement "all pending → pending" rule
- [ ] 6.3 Implement "any in_progress → in_progress" rule
- [ ] 6.4 Implement "all completed → completed" rule
- [ ] 6.5 Implement "mixed pending+completed → in_progress" rule
- [ ] 6.6 Add unit tests for all status aggregation scenarios

## 7. Status Preservation Across Regeneration

- [ ] 7.1 Add `loadExistingStatuses()` function to read old tasks.jsonc files
- [ ] 7.2 Build map of task ID → status from existing files
- [ ] 7.3 Add logic to merge old statuses with new task structure during write
- [ ] 7.4 Add unit tests for status preservation when IDs match
- [ ] 7.5 Add unit tests for new tasks getting "pending" status

## 8. Child File Header Generation

- [ ] 8.1 Add `childFileHeader()` function to generate header with origin info
- [ ] 8.2 Include "Generated by: spectr accept [change-id]" line
- [ ] 8.3 Include "Parent change: [change-id]" line
- [ ] 8.4 Include "Parent task: [task-id]" line
- [ ] 8.5 Include full standard header (status values, transitions)
- [ ] 8.6 Add unit tests for header generation with all fields

## 9. File Writing Functions

- [ ] 9.1 Add `writeHierarchicalTasks()` orchestration function in
  `cmd/accept_writer.go`
- [ ] 9.2 Add `writeRootTasksJSONC()` to write root file with reference tasks
- [ ] 9.3 Add `writeChildTasksJSONC()` to write tasks-N.jsonc files
- [ ] 9.4 Add `deleteOldChildFiles()` function to clean up tasks-*.jsonc before
  regeneration
- [ ] 9.5 Update existing `writeTasksJSONC()` to route to hierarchical path when
  needed
- [ ] 9.6 Add includes field `["tasks-*.jsonc"]` to root file
- [ ] 9.7 Add unit tests for root file generation with references
- [ ] 9.8 Add unit tests for child file generation
- [ ] 9.9 Add unit tests for old file cleanup

## 10. Accept Command Integration

- [ ] 10.1 Update `processChange()` in `cmd/accept.go` to call `shouldSplit()`
- [ ] 10.2 Route to `writeHierarchicalTasks()` when splitting is needed
- [ ] 10.3 Route to existing `writeTasksJSONC()` for flat files (version 1)
- [ ] 10.4 Add integration test with 150-line tasks.md generating split files
- [ ] 10.5 Add integration test with 80-line tasks.md generating flat file
- [ ] 10.6 Add integration test for regeneration preserving statuses

## 11. Backwards Compatibility

- [ ] 11.1 Ensure version 1 files are parsed correctly (no split lookup)
- [ ] 11.2 Add `isVersionTwo()` function to detect hierarchical format
- [ ] 11.3 Add unit tests for reading version 1 flat files
- [ ] 11.4 Add unit tests for version 1 → version 2 upgrade path
- [ ] 11.5 Add integration test with mixed version 1 and version 2 changes

## 12. Edge Cases and Error Handling

- [ ] 12.1 Handle tasks.md with no sections (generate flat file)
- [ ] 12.2 Handle tasks.md with only one section (no splitting needed)
- [ ] 12.3 Handle tasks.md exactly 100 lines (use flat format)
- [ ] 12.4 Handle tasks.md with 101 lines (trigger splitting)
- [ ] 12.5 Handle malformed task IDs gracefully
- [ ] 12.6 Handle missing parent tasks in child files (validation error)
- [ ] 12.7 Add unit tests for all edge cases

## 13. Documentation

- [ ] 13.1 Update AGENTS.md with version 2 format documentation
- [ ] 13.2 Add example hierarchical tasks.jsonc structure to AGENTS.md
- [ ] 13.3 Document 100-line threshold and splitting behavior
- [ ] 13.4 Document child file naming convention (tasks-N.jsonc)
- [ ] 13.5 Document status aggregation rules
- [ ] 13.6 Update internal code comments for new functions

## 14. Testing and Validation

- [ ] 14.1 Run `nix develop -c tests` to ensure all unit tests pass
- [ ] 14.2 Run `nix develop -c lint` to ensure code quality
- [ ] 14.3 Create manual test change with 150+ line tasks.md
- [ ] 14.4 Run `spectr accept` on manual test change and verify split files
- [ ] 14.5 Verify agent can read root file in single Read operation
- [ ] 14.6 Verify agent can read child files in single Read operation
- [ ] 14.7 Update task status in child file and verify regeneration preserves it
- [ ] 14.8 Run `spectr validate` on test change to ensure specs are valid

## 15. Cleanup and Archive Old Proposal

- [ ] 15.1 Archive the `add-hierarchical-tasks` change without implementing
- [ ] 15.2 Add note in archive explaining it was superseded by this change
- [ ] 15.3 Clean up any stale development artifacts
