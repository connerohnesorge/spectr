## MODIFIED Requirements

### Requirement: Tasks JSON Schema

The accept command SHALL generate `tasks.jsonc` files conforming to a versioned schema with structured task objects, header comments, and optional hierarchical structure for large changes.

#### Scenario: JSONC file structure

- WHEN the accept command creates tasks.jsonc
- THEN the file SHALL start with header comments documenting task status values
- AND the file SHALL contain a root object with `version` and `tasks` fields
- AND `version` SHALL be integer 2 for this schema version (backwards compatible with version 1)
- AND `tasks` SHALL be an array of task objects

#### Scenario: Header comment content

- WHEN the accept command creates tasks.jsonc
- THEN the header SHALL use `//` line comment syntax
- AND the header SHALL indicate the file is machine-generated by `spectr accept`
- AND the header SHALL document the three valid status values: "pending", "in_progress", "completed"
- AND the header SHALL document valid status transitions: pending -> in_progress -> completed
- AND the header SHALL explain that agents should mark a task "in_progress" when starting work
- AND the header SHALL explain that agents should mark a task "completed" only after verification
- AND the header SHALL note that skipping directly from "pending" to "completed" is allowed for trivial tasks

#### Scenario: Task object structure

- WHEN a task is serialized to JSONC
- THEN it SHALL have `id` field containing the task identifier (e.g., "1.1")
- AND it SHALL have `section` field containing the section header (e.g., "Implementation")
- AND it SHALL have `description` field containing the full task text
- AND it SHALL have `status` field with value "pending", "in_progress", or "completed"
- AND it MAY have `children` field with value "$ref:<path>" for hierarchical tasks

#### Scenario: Status value mapping from Markdown

- WHEN converting tasks.md to tasks.jsonc
- THEN `- [ ]` SHALL map to status "pending"
- AND `- [x]` (case-insensitive) SHALL map to status "completed"

#### Scenario: Version 1 backwards compatibility

- WHEN reading a tasks.jsonc with version 1
- THEN the system SHALL treat it as a flat task list
- AND all existing functionality SHALL work unchanged

### Requirement: Accept Command Structure

The CLI SHALL provide an `accept` command that converts `tasks.md` to `tasks.jsonc` format with header comments for stable agent manipulation during implementation.

#### Scenario: Accept command registration

- WHEN the CLI is initialized
- THEN it SHALL include an AcceptCmd struct field tagged with `cmd`
- AND the command SHALL be accessible via `spectr accept`
- AND the command help text SHALL reference tasks.jsonc output

#### Scenario: Accept with change ID

- WHEN user runs `spectr accept <change-id>`
- THEN the system validates the change exists in `spectr/changes/<change-id>/`
- AND the system parses `tasks.md` into structured format
- AND the system writes `tasks.jsonc` with proper schema and header comments
- AND the system removes `tasks.md` to prevent drift

#### Scenario: Accept with validation

- WHEN user runs `spectr accept <change-id>`
- THEN the system validates the change before conversion
- AND if validation fails, the system aborts
- AND the system displays validation errors

#### Scenario: Accept dry-run mode

- WHEN user runs `spectr accept <change-id> --dry-run`
- THEN the system displays what would be converted
- AND the system does NOT write tasks.jsonc
- AND the system does NOT remove tasks.md

#### Scenario: Accept already accepted change

- WHEN user runs `spectr accept <change-id>` on a change that already has tasks.jsonc
- THEN the system displays a message indicating change is already accepted
- AND the system exits with code 0 (success, idempotent)

#### Scenario: Accept change without tasks.md

- WHEN user runs `spectr accept <change-id>` on a change without tasks.md
- THEN the system displays an error indicating no tasks.md found
- AND the system exits with code 1

## ADDED Requirements

### Requirement: Hierarchical Tasks Structure

The tasks.jsonc format SHALL support hierarchical task organization where root tasks can reference child tasks in delta spec directories.

#### Scenario: Root file with summary

- WHEN a tasks.jsonc uses hierarchical structure (version 2)
- THEN the root object MAY contain a `summary` field
- AND `summary` SHALL contain `total`, `completed`, `in_progress`, and `pending` counts
- AND counts SHALL reflect aggregated status across all referenced child files

#### Scenario: Child task references

- WHEN a task has `children` field with value "$ref:specs/<capability>/tasks.jsonc"
- THEN the referenced file SHALL contain tasks that are children of this task
- AND child task IDs SHALL use the parent ID as prefix (e.g., parent "5" has children "5.1", "5.2")

#### Scenario: Auto-discovery via includes

- WHEN a tasks.jsonc contains `includes` field with glob patterns
- THEN the system SHALL discover matching task files automatically
- AND discovered files SHALL be included after explicit children references
- AND duplicate files (by path) SHALL be processed only once

#### Scenario: Child file structure

- WHEN a delta spec has its own tasks.jsonc (`specs/<capability>/tasks.jsonc`)
- THEN it SHALL contain a `parent` field with the parent task ID
- AND it SHALL contain a `tasks` array with child tasks
- AND it SHALL use version 2 format
- AND the header comments MAY be abbreviated (status values only)

#### Scenario: Hierarchical ID schema

- WHEN tasks use hierarchical IDs
- THEN root-level tasks SHALL use single numbers (e.g., "1", "2", "5")
- AND first-level children SHALL use parent.child format (e.g., "5.1", "5.2")
- AND deeper nesting SHALL extend the pattern (e.g., "5.1.1")
- AND maximum nesting depth SHALL be 2 levels (root -> capability)

### Requirement: Auto-Split on Accept

The `spectr accept` command SHALL automatically split tasks into capability-specific files when section names match delta spec directories.

#### Scenario: Section matches delta spec

- WHEN accepting a change with section "5. Support Aider"
- AND delta spec directory `specs/support-aider/` exists
- THEN tasks from that section SHALL be written to `specs/support-aider/tasks.jsonc`
- AND root tasks.jsonc SHALL contain a reference task with `children` field

#### Scenario: Section name normalization

- WHEN matching section names to delta spec directories
- THEN section names SHALL be normalized to kebab-case
- AND leading numbers and punctuation SHALL be stripped (e.g., "5. Support Aider" -> "support-aider")
- AND matching SHALL be case-insensitive

#### Scenario: No matching delta spec

- WHEN a section does not match any delta spec directory
- THEN tasks from that section SHALL remain in the root tasks.jsonc
- AND they SHALL be written as flat tasks (no children reference)

#### Scenario: Mixed structure

- WHEN some sections match delta specs and others do not
- THEN the root tasks.jsonc SHALL contain:
  - Flat tasks for non-matching sections
  - Reference tasks with children for matching sections
- AND the appropriate child files SHALL be created

#### Scenario: Auto-discovery pattern

- WHEN hierarchical tasks.jsonc is generated
- THEN root file SHALL include `"includes": ["specs/*/tasks.jsonc"]` for auto-discovery
- AND this enables agents to find child files without explicit references

### Requirement: Tasks Command

The CLI SHALL provide a `tasks` command for viewing task status across hierarchical task files.

#### Scenario: Tasks command registration

- WHEN the CLI is initialized
- THEN it SHALL include a TasksCmd struct field tagged with `cmd`
- AND the command SHALL be accessible via `spectr tasks`

#### Scenario: Summary view (default)

- WHEN user runs `spectr tasks <change-id>`
- THEN the system displays section-by-section progress summary
- AND each section shows completed/total counts
- AND total progress percentage is displayed at the end

#### Scenario: Flatten view

- WHEN user runs `spectr tasks <change-id> --flatten`
- THEN the system displays all tasks from root and child files
- AND tasks are shown with full hierarchical IDs
- AND output format matches flat tasks.jsonc structure

#### Scenario: JSON output

- WHEN user runs `spectr tasks <change-id> --json`
- THEN the system outputs merged task data as JSON
- AND includes all tasks from root and child files
- AND includes aggregated summary counts

#### Scenario: Interactive change selection

- WHEN user runs `spectr tasks` without specifying a change ID
- THEN the system displays a list of active changes with tasks.jsonc files
- AND prompts for selection using existing TUI components

#### Scenario: Missing tasks file

- WHEN user runs `spectr tasks <change-id>` on a change without tasks.jsonc
- THEN the system displays an error indicating no tasks.jsonc found
- AND suggests running `spectr accept` first
- AND the system exits with code 1

### Requirement: Child File Validation

The validation system SHALL validate hierarchical task file references.

#### Scenario: Valid child reference

- WHEN validating a tasks.jsonc with children references
- AND all referenced files exist and have valid format
- THEN validation SHALL pass

#### Scenario: Missing child file

- WHEN validating a tasks.jsonc with children reference to non-existent file
- THEN validation SHALL report an error
- AND error message SHALL include the missing file path

#### Scenario: Invalid child format

- WHEN a referenced child tasks.jsonc has invalid format
- THEN validation SHALL report an error
- AND error message SHALL identify the specific file and issue

#### Scenario: Orphaned child files

- WHEN a delta spec has tasks.jsonc but is not referenced by root
- AND root has auto-discovery includes pattern
- THEN validation SHALL pass (file is discovered)

#### Scenario: Circular references

- WHEN a child tasks.jsonc references another child file
- THEN validation SHALL report an error
- AND error message SHALL indicate circular reference detected
