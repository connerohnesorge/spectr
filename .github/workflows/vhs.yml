name: VHS GIF Generation

on:
  push:
    paths:
      - "assets/vhs/*.tape"
    branches:
      - main
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate-gifs:
    name: Generate GIFs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Build spectr
        run: nix build .#

      - name: Add spectr to PATH
        run: echo "${{ github.workspace }}/result/bin" >> $GITHUB_PATH

      - name: Generate GIFs from tape files
        uses: charmbracelet/vhs-action@v2
        with:
          path: "assets/vhs/*.tape"

      - name: Move generated GIFs to assets/gifs
        run: |
          mkdir -p assets/gifs
          for tape in assets/vhs/*.tape; do
            gif_name=$(basename "$tape" .tape).gif
            if [ -f "assets/vhs/$gif_name" ]; then
              mv "assets/vhs/$gif_name" "assets/gifs/$gif_name"
            fi
          done

      - name: Commit generated GIFs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-generate GIFs from VHS tape files"
          commit_author: "vhs-action <vhs-action@users.noreply.github.com>"
          file_pattern: "assets/gifs/*.gif"
